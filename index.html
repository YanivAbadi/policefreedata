<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>מערכת צפייה בנתוני פשיעה לפי יישוב</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 0.5rem;
    }
    .filters {
      background: #ffffff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      align-items: start;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }
    select, button, input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      font-weight: bold;
      cursor: pointer;
    }
    #status {
      margin-bottom: 10px;
      font-size: 0.9rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #eee;
      text-align: right;
      font-size: 0.9rem;
    }
    th {
      background: #fafafa;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }
    #summaryContainer {
      margin-bottom: 20px;
      background: #ffffff;
      padding: 10px 15px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }
    #summaryContainer h2 {
      margin-top: 0;
      margin-bottom: 4px;
      font-size: 1rem;
    }
    #summaryStatus {
      margin: 4px 0 10px;
      font-size: 0.85rem;
      color: #555;
    }
    #summaryTable {
      box-shadow: none;
    }
    .table-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .table-header-row h2,
    .table-header-row h3 {
      margin: 0;
    }
    .download-btn {
      width: auto;
      padding-inline: 10px;
      font-size: 0.8rem;
      white-space: nowrap;
    }
    .years-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fafafa;
    }
    .years-checkboxes label {
      font-weight: normal;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 0;
      font-size: 0.9rem;
    }
    .city-block input[type="text"] {
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <h1>נתוני פשיעה לפי יישוב, שנה וסוג עבירה</h1>
  <p>בחר יישוב, שנה/שנים ועבירה כדי לראות את הרשומות הרלוונטיות ממאגר המידע המשטרתי.</p>

  <div class="filters">
    <div>
      <label>שנה (ניתן לבחור כמה)</label>
      <div class="years-checkboxes">
        <label><input type="checkbox" class="yearCheckbox" value="2023"> 2023</label>
        <label><input type="checkbox" class="yearCheckbox" value="2024"> 2024</label>
        <label><input type="checkbox" class="yearCheckbox" value="2025"> 2025</label>
      </div>
    </div>

    <div class="city-block">
      <label>יישוב (חיפוש בתוך הרשימה)</label>
      <input id="citySearch" type="text" placeholder="התחל להקליד לסינון הרשימה..." />
      <select id="citySelect" size="8" disabled>
        <option value="">— בחר שנה קודם —</option>
      </select>
    </div>

    <div>
      <label for="crimeGroupSelect">קבוצת עבירה</label>
      <select id="crimeGroupSelect">
        <option value="">— כל הקבוצות —</option>
      </select>
    </div>

    <div>
      <label for="crimeTypeSelect">סוג עבירה</label>
      <select id="crimeTypeSelect">
        <option value="">— כל הסוגים —</option>
      </select>
    </div>

    <div style="align-self: end;">
      <button id="searchButton">חפש</button>
    </div>
  </div>

  <div id="status">ממתין לבחירת שנה...</div>

  <div id="summaryContainer">
    <div class="table-header-row">
      <h2>סיכום העבירות המוצגות</h2>
      <button id="downloadSummaryBtn" class="download-btn" disabled>הורד סיכום לאקסל</button>
    </div>
    <p id="summaryStatus">לא הוצגו עדיין נתונים.</p>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>שנה</th>
          <th>רבעון</th>
          <th>קבוצת עבירה</th>
          <th>מספר רשומות</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="table-header-row">
    <h3>רשימת הרשומות המלאה</h3>
    <button id="downloadResultsBtn" class="download-btn" disabled>הורד נתונים לאקסל</button>
  </div>
  <table id="resultsTable">
    <thead>
      <tr>
        <th>שנה</th>
        <th>רבעון</th>
        <th>יישוב</th>
        <th>קבוצת עבירה</th>
        <th>סוג עבירה</th>
        <th>מחוז</th>
        <th>תחנה</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const BASE_URL = "https://data.gov.il/api/3/action/datastore_search";

    const YEAR_RESOURCE_MAP = {
      2023: "32aacfc9-3524-4fba-a282-3af052380244",
      2024: "5fc13c50-b6f3-4712-b831-a75e0f91a17e",
      2025: "e311b6a1-be5a-4a82-8298-f3afbee07b6b",
    };

    const CRIMES_RESOURCE_ID = "b53b64f8-57ed-4213-9191-a7401c0cf436";

    const yearCheckboxes   = document.querySelectorAll(".yearCheckbox");
    const citySearchInput  = document.getElementById("citySearch");
    const citySelect       = document.getElementById("citySelect");
    const crimeGroupSelect = document.getElementById("crimeGroupSelect");
    const crimeTypeSelect  = document.getElementById("crimeTypeSelect");
    const searchButton     = document.getElementById("searchButton");
    const statusDiv        = document.getElementById("status");
    const resultsTableBody = document.querySelector("#resultsTable tbody");

    const summaryStatus    = document.getElementById("summaryStatus");
    const summaryTableBody = document.querySelector("#summaryTable tbody");

    const downloadSummaryBtn = document.getElementById("downloadSummaryBtn");
    const downloadResultsBtn = document.getElementById("downloadResultsBtn");

    const cache = {
      crimesMeta: null,
      yearData: {}  // רשומות גולמיות לפי שנה (לצורך יישובים)
    };

    const citiesState = {
      years: [],
      cities: []
    };

    async function fetchFromDataGov(resourceId, extraParams = {}) {
      const params = new URLSearchParams({
        resource_id: resourceId,
        limit: extraParams.limit || 5000,
      });

      if (extraParams.filters) {
        params.set("filters", JSON.stringify(extraParams.filters));
      }

      const url = `${BASE_URL}?${params.toString()}`;

      const res = await fetch(url);
      if (!res.ok) {
        throw new Error("שגיאה בקריאת ה־API: " + res.status);
      }
      const data = await res.json();
      if (!data.success) {
        throw new Error("ה־API החזיר תשובה לא תקינה");
      }
      return data.result.records;
    }

    function setStatus(text) {
      statusDiv.textContent = text;
    }

    function clearTable() {
      resultsTableBody.innerHTML = "";
      downloadResultsBtn.disabled = true;
    }

    function clearSummary() {
      summaryStatus.textContent = "לא הוצגו עדיין נתונים.";
      summaryTableBody.innerHTML = "";
      downloadSummaryBtn.disabled = true;
    }

    function fillSelectOptions(selectEl, values, { includeEmpty = true, emptyText = "— כולם —" } = {}) {
      selectEl.innerHTML = "";
      if (includeEmpty) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = emptyText;
        selectEl.appendChild(opt);
      }
      values.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      });
    }

    function getSelectedYears() {
      return Array.from(yearCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    }

    async function loadCrimesMeta() {
      if (cache.crimesMeta) return cache.crimesMeta;

      setStatus("טוען רשימת עבירות (API 3)...");
      const records = await fetchFromDataGov(CRIMES_RESOURCE_ID, { limit: 5000 });
      cache.crimesMeta = records;

      const groups = [...new Set(records.map(r => r.StatisticCrimeGroupName).filter(Boolean))].sort();
      fillSelectOptions(crimeGroupSelect, groups, { includeEmpty: true, emptyText: "— כל הקבוצות —" });

      setStatus("רשימת העבירות נטענה. בחר שנה/שנים ויישוב.");
      return records;
    }

    function updateCrimeTypesForGroup(groupName) {
      const records = cache.crimesMeta || [];
      let types;

      if (!groupName) {
        types = [...new Set(records.map(r => r.StatisticCrimeTypeName).filter(Boolean))];
      } else {
        types = [
          ...new Set(
            records
              .filter(r => r.StatisticCrimeGroupName === groupName)
              .map(r => r.StatisticCrimeTypeName)
              .filter(Boolean)
          )
        ];
      }

      types.sort();
      fillSelectOptions(crimeTypeSelect, types, { includeEmpty: true, emptyText: "— כל הסוגים —" });
    }

    crimeGroupSelect.addEventListener("change", () => {
      const groupName = crimeGroupSelect.value;
      updateCrimeTypesForGroup(groupName);
    });

    async function loadCitiesForYears(years) {
      citiesState.years = years;
      citiesState.cities = [];
      citySearchInput.value = "";
      citySelect.disabled = true;
      citySelect.innerHTML = '<option value="">— טוען יישובים... —</option>';

      if (!years.length) {
        citySelect.disabled = true;
        citySelect.innerHTML = '<option value="">— בחר שנה קודם —</option>';
        setStatus("ממתין לבחירת שנה...");
        return;
      }

      setStatus(`טוען יישובים עבור השנים שנבחרו...`);

      const allCitiesSet = new Set();

      for (const year of years) {
        const resourceId = YEAR_RESOURCE_MAP[year];
        if (!resourceId) continue;

        let records;
        if (cache.yearData[year]) {
          records = cache.yearData[year];
        } else {
          records = await fetchFromDataGov(resourceId, { limit: 5000 });
          cache.yearData[year] = records;
        }

        records.forEach(r => {
          if (r.Yeshuv) {
            allCitiesSet.add(r.Yeshuv);
          }
        });
      }

      const cities = [...allCitiesSet].sort();
      citiesState.cities = cities;

      if (!cities.length) {
        citySelect.disabled = true;
        citySelect.innerHTML = '<option value="">— לא נמצאו יישובים —</option>';
        setStatus("לא נמצאו יישובים עבור השנים שנבחרו.");
        return;
      }

      fillSelectOptions(citySelect, cities, { includeEmpty: true, emptyText: "— כל היישובים —" });
      citySelect.disabled = false;

      setStatus(`נטענו ${cities.length} יישובים עבור השנים שנבחרו. סנן ברשימה, בחר יישוב ועבירה ולחץ חפש.`);
    }

    function filterCitiesBySearch() {
      const query = citySearchInput.value.trim().toLowerCase();
      const cities = citiesState.cities || [];

      let filtered = cities;
      if (query) {
        filtered = cities.filter(c => c.toLowerCase().includes(query));
      }

      fillSelectOptions(citySelect, filtered, { includeEmpty: true, emptyText: "— כל היישובים —" });
      citySelect.disabled = filtered.length === 0;
    }

    citySearchInput.addEventListener("input", filterCitiesBySearch);

    yearCheckboxes.forEach(cb => {
      cb.addEventListener("change", async () => {
        const years = getSelectedYears();
        clearTable();
        clearSummary();
        try {
          await loadCitiesForYears(years);
        } catch (err) {
          console.error(err);
          setStatus("שגיאה בטעינת היישובים. בדוק חיבור לרשת או נסה שוב מאוחר יותר.");
        }
      });
    });

    async function search() {
      clearTable();
      clearSummary();

      const years = getSelectedYears();
      if (!years.length) {
        setStatus("יש לבחור לפחות שנה אחת לפני החיפוש.");
        return;
      }

      const city       = citySelect.value;
      const groupName  = crimeGroupSelect.value;
      const typeName   = crimeTypeSelect.value;

      const baseFilters = {};
      if (city)      baseFilters.Yeshuv         = city;
      if (groupName) baseFilters.StatisticGroup = groupName;
      if (typeName)  baseFilters.StatisticType  = typeName;

      const allRecords = [];
      setStatus("מחפש נתונים במאגר עבור כל השנים הנבחרות...");

      for (const year of years) {
        const resourceId = YEAR_RESOURCE_MAP[year];
        if (!resourceId) continue;

        const filters = { ...baseFilters };
        try {
          const records = await fetchFromDataGov(resourceId, {
            limit: 5000,
            filters
          });
          allRecords.push(...records);
        } catch (err) {
          console.error("שגיאה עבור שנה", year, err);
        }
      }

      setStatus(`נמצאו ${allRecords.length} רשומות לפי הסינון שבחרת.`);
      renderResults(allRecords);
      renderSummary(allRecords);
    }

    function renderResults(records) {
      clearTable();
      if (!records.length) return;

      records.forEach(r => {
        const tr = document.createElement("tr");

        const yearTd     = document.createElement("td");
        const quarterTd  = document.createElement("td");
        const cityTd     = document.createElement("td");
        const groupTd    = document.createElement("td");
        const typeTd     = document.createElement("td");
        const districtTd = document.createElement("td");
        const stationTd  = document.createElement("td");

        yearTd.textContent     = r.Year ?? "";
        quarterTd.textContent  = r.Quarter ?? "";
        cityTd.textContent     = r.Yeshuv ?? "";
        groupTd.textContent    = r.StatisticGroup ?? "";
        typeTd.textContent     = r.StatisticType ?? "";
        districtTd.textContent = r.PoliceDistrict ?? "";
        stationTd.textContent  = r.PoliceStation ?? "";

        tr.appendChild(yearTd);
        tr.appendChild(quarterTd);
        tr.appendChild(cityTd);
        tr.appendChild(groupTd);
        tr.appendChild(typeTd);
        tr.appendChild(districtTd);
        tr.appendChild(stationTd);

        resultsTableBody.appendChild(tr);
      });

      downloadResultsBtn.disabled = false;
    }

    function renderSummary(records) {
      clearSummary();

      if (!records.length) {
        summaryStatus.textContent = "אין נתונים להצגה לפי הסינון הנוכחי.";
        return;
      }

      const agg = {};
      records.forEach(r => {
        const year    = r.Year ?? "";
        const quarter = r.Quarter ?? "";
        const group   = r.StatisticGroup ?? "";

        const key = year + "|" + quarter + "|" + group;
        if (!agg[key]) {
          agg[key] = { year, quarter, group, count: 0 };
        }
        agg[key].count++;
      });

      const rows = Object.values(agg);

      rows.sort((a, b) => {
        if (a.year !== b.year) return (a.year || 0) - (b.year || 0);
        if (a.quarter !== b.quarter) return (a.quarter || 0) - (b.quarter || 0);
        return (a.group || "").localeCompare(b.group || "", "he");
      });

      rows.forEach(row => {
        const tr = document.createElement("tr");

        const yearTd = document.createElement("td");
        const qTd    = document.createElement("td");
        const gTd    = document.createElement("td");
        const cTd    = document.createElement("td");

        yearTd.textContent = row.year;
        qTd.textContent    = row.quarter;
        gTd.textContent    = row.group;
        cTd.textContent    = row.count;

        tr.appendChild(yearTd);
        tr.appendChild(qTd);
        tr.appendChild(gTd);
        tr.appendChild(cTd);

        summaryTableBody.appendChild(tr);
      });

      summaryStatus.textContent = "סיכום לפי שנה, רבעון וקבוצת עבירה (מספר רשומות בכל שילוב).";
      downloadSummaryBtn.disabled = false;
    }

    function tableToCSV(tableEl) {
      const rows = Array.from(tableEl.querySelectorAll("tr"));
      const csvRows = rows.map(row => {
        const cells = Array.from(row.querySelectorAll("th,td"));
        return cells.map(cell => {
          let text = cell.textContent.replace(/"/g, '""');
          if (text.search(/("|,|\n)/g) >= 0) {
            text = '"' + text + '"';
          }
          return text;
        }).join(",");
      });
      return csvRows.join("\n");
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    downloadSummaryBtn.addEventListener("click", () => {
      const csv = tableToCSV(document.getElementById("summaryTable"));
      downloadCSV(csv, "crime_summary.csv");
    });

    downloadResultsBtn.addEventListener("click", () => {
      const csv = tableToCSV(document.getElementById("resultsTable"));
      downloadCSV(csv, "crime_records.csv");
    });

    searchButton.addEventListener("click", () => {
      search();
    });

    (async function init() {
      try {
        await loadCrimesMeta();
      } catch (err) {
        console.error(err);
        setStatus("שגיאה בטעינת מטא־דאטה של העבירות (API 3).");
      }
    })();
  </script>
</body>
</html>
